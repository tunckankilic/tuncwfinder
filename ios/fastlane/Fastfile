# iOS Fastlane Configuration
# Docs: https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  # ============================================
  # Lanes
  # ============================================
  
  desc "ğŸ“ Flutter pub get ve CocoaPods kurulumu"
  lane :setup do
    # Flutter baÄŸÄ±mlÄ±lÄ±klarÄ±
    sh("cd ../.. && flutter pub get")
    
    # CocoaPods kurulumu
    cocoapods(
      clean_install: true,
      podfile: "./Podfile"
    )
  end

  desc "ğŸ§ª Testleri Ã§alÄ±ÅŸtÄ±r"
  lane :test do
    sh("cd ../.. && flutter test")
  end

  desc "ğŸ”¨ Release build oluÅŸtur"
  lane :build do
    setup
    
    # Flutter iOS build
    sh("cd ../.. && flutter build ios --release --no-codesign")
  end

  desc "ğŸ“¦ Beta sÃ¼rÃ¼mÃ¼ TestFlight'a yÃ¼kle"
  lane :beta do
    setup
    
    # SertifikalarÄ± yÃ¼kle (match kullanÄ±lÄ±yorsa)
    # match(type: "appstore", readonly: true)
    
    # Build number'Ä± artÄ±r
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )
    
    # Flutter build
    sh("cd ../.. && flutter build ipa --release")
    
    # TestFlight'a yÃ¼kle
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      ipa: "../build/ios/ipa/tuncforwork.ipa"
    )
    
    # Slack bildirimi (opsiyonel)
    # slack(
    #   message: "ğŸ iOS Beta baÅŸarÄ±yla yÃ¼klendi!",
    #   slack_url: ENV["SLACK_WEBHOOK_URL"]
    # )
  end

  desc "ğŸš€ Production sÃ¼rÃ¼mÃ¼ App Store'a yÃ¼kle"
  lane :production do
    setup
    
    # SertifikalarÄ± yÃ¼kle
    # match(type: "appstore", readonly: true)
    
    # Build number'Ä± artÄ±r
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )
    
    # Flutter build
    sh("cd ../.. && flutter build ipa --release")
    
    # App Store'a yÃ¼kle
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      ipa: "../build/ios/ipa/tuncforwork.ipa",
      submit_for_review: false
    )
  end

  desc "ğŸ“¸ Screenshot'larÄ± yakala"
  lane :screenshots do
    capture_screenshots(scheme: "Runner")
  end

  # ============================================
  # Code Signing (Match)
  # ============================================
  
  desc "ğŸ”‘ SertifikalarÄ± senkronize et (development)"
  lane :sync_dev_certs do
    match(
      type: "development",
      readonly: false,
      force_for_new_devices: true
    )
  end

  desc "ğŸ”‘ SertifikalarÄ± senkronize et (appstore)"
  lane :sync_appstore_certs do
    match(
      type: "appstore",
      readonly: false
    )
  end

  # ============================================
  # Error Handling
  # ============================================
  
  error do |lane, exception|
    # Hata durumunda Slack bildirimi (opsiyonel)
    # slack(
    #   message: "âŒ iOS #{lane} lane baÅŸarÄ±sÄ±z oldu!",
    #   success: false,
    #   slack_url: ENV["SLACK_WEBHOOK_URL"],
    #   attachment_properties: {
    #     fields: [
    #       {
    #         title: "Error",
    #         value: exception.message,
    #         short: false
    #       }
    #     ]
    #   }
    # )
  end
end
