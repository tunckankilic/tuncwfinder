# Android Fastlane Configuration
# Docs: https://docs.fastlane.tools

default_platform(:android)

platform :android do
  # ============================================
  # Lanes
  # ============================================
  
  desc "ğŸ“ Flutter pub get"
  lane :setup do
    sh("cd ../.. && flutter pub get")
  end

  desc "ğŸ§ª Testleri Ã§alÄ±ÅŸtÄ±r"
  lane :test do
    sh("cd ../.. && flutter test")
  end

  desc "ğŸ”¨ Debug APK oluÅŸtur"
  lane :build_debug do
    setup
    sh("cd ../.. && flutter build apk --debug")
  end

  desc "ğŸ”¨ Release APK oluÅŸtur"
  lane :build_release do
    setup
    sh("cd ../.. && flutter build apk --release")
  end

  desc "ğŸ”¨ Release App Bundle oluÅŸtur"
  lane :build_bundle do
    setup
    sh("cd ../.. && flutter build appbundle --release")
  end

  desc "ğŸ“¦ Beta sÃ¼rÃ¼mÃ¼ Internal Test'e yÃ¼kle"
  lane :beta do
    setup
    
    # Build number'Ä± gÃ¼ncelle (opsiyonel)
    # version_code = google_play_track_version_codes(track: "internal")[0] + 1
    
    # App Bundle oluÅŸtur
    sh("cd ../.. && flutter build appbundle --release")
    
    # Play Store Internal Test'e yÃ¼kle
    upload_to_play_store(
      track: "internal",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    
    # Slack bildirimi (opsiyonel)
    # slack(
    #   message: "ğŸ¤– Android Beta baÅŸarÄ±yla yÃ¼klendi!",
    #   slack_url: ENV["SLACK_WEBHOOK_URL"]
    # )
  end

  desc "ğŸ“¦ Alpha sÃ¼rÃ¼mÃ¼ Closed Test'e yÃ¼kle"
  lane :alpha do
    setup
    
    # App Bundle oluÅŸtur
    sh("cd ../.. && flutter build appbundle --release")
    
    # Play Store Alpha'ya yÃ¼kle
    upload_to_play_store(
      track: "alpha",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "ğŸš€ Production sÃ¼rÃ¼mÃ¼ Play Store'a yÃ¼kle"
  lane :production do
    setup
    
    # App Bundle oluÅŸtur
    sh("cd ../.. && flutter build appbundle --release")
    
    # Play Store Production'a yÃ¼kle
    upload_to_play_store(
      track: "production",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: "draft"  # Manuel onay iÃ§in draft olarak bÄ±rak
    )
  end

  desc "ğŸ”„ Staged rollout ile yÃ¼kle"
  lane :staged_rollout do |options|
    rollout_percentage = options[:percentage] || 10
    
    setup
    sh("cd ../.. && flutter build appbundle --release")
    
    upload_to_play_store(
      track: "production",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      rollout: rollout_percentage.to_s,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "ğŸ“‹ Play Store metadata'yÄ± gÃ¼ncelle"
  lane :update_metadata do
    upload_to_play_store(
      track: "production",
      skip_upload_aab: true,
      skip_upload_apk: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "ğŸ“¸ Play Store screenshot'larÄ±nÄ± yÃ¼kle"
  lane :upload_screenshots do
    upload_to_play_store(
      track: "production",
      skip_upload_aab: true,
      skip_upload_apk: true,
      skip_upload_metadata: true
    )
  end

  # ============================================
  # Helper Lanes
  # ============================================
  
  desc "ğŸ”‘ Version code'u artÄ±r"
  lane :increment_version do
    # En son version code'u al
    version_codes = google_play_track_version_codes(track: "internal")
    new_version_code = version_codes[0] + 1
    
    UI.message("Yeni version code: #{new_version_code}")
    
    # Build gradle'da gÃ¼ncelle (manuel veya script ile)
    new_version_code
  end

  desc "ğŸ§¹ Build klasÃ¶rlerini temizle"
  lane :clean do
    sh("cd ../.. && flutter clean")
    sh("cd ../.. && flutter pub get")
  end

  # ============================================
  # Error Handling
  # ============================================
  
  error do |lane, exception|
    # Hata durumunda Slack bildirimi (opsiyonel)
    # slack(
    #   message: "âŒ Android #{lane} lane baÅŸarÄ±sÄ±z oldu!",
    #   success: false,
    #   slack_url: ENV["SLACK_WEBHOOK_URL"],
    #   attachment_properties: {
    #     fields: [
    #       {
    #         title: "Error",
    #         value: exception.message,
    #         short: false
    #       }
    #     ]
    #   }
    # )
  end
end
